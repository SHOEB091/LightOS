/**
 * LightOS GUI
 * Basic GUI implementation
 */

#include "gui.h"
#include "../kernel/kernel.h"
#include "../kernel/memory.h"

// GUI state
static int gui_initialized = 0;
static int gui_mode = GUI_MODE_TEXT;
static unsigned int* framebuffer = NULL;
static int framebuffer_width = 0;
static int framebuffer_height = 0;
static int framebuffer_bpp = 0;
static int framebuffer_pitch = 0;

// GUI colors
#define GUI_COLOR_BLACK        0x000000
#define GUI_COLOR_WHITE        0xFFFFFF
#define GUI_COLOR_RED          0xFF0000
#define GUI_COLOR_GREEN        0x00FF00
#define GUI_COLOR_BLUE         0x0000FF
#define GUI_COLOR_YELLOW       0xFFFF00
#define GUI_COLOR_CYAN         0x00FFFF
#define GUI_COLOR_MAGENTA      0xFF00FF
#define GUI_COLOR_DARK_GRAY    0x404040
#define GUI_COLOR_LIGHT_GRAY   0xC0C0C0

// Current drawing color
static unsigned int current_color = GUI_COLOR_WHITE;

// Font data (a simple 8x8 font)
// This would be expanded in a real system
static const unsigned char font_8x8[128][8] = {
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x00
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x01
    // ... more characters would be defined here
    { 0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00 }, // 0x21 !
    { 0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x22 "
    { 0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00 }, // 0x23 #
    { 0x0C, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x0C, 0x00 }, // 0x24 $
    { 0x00, 0x63, 0x33, 0x18, 0x0C, 0x66, 0x63, 0x00 }, // 0x25 %
    { 0x1C, 0x36, 0x1C, 0x6E, 0x3B, 0x33, 0x6E, 0x00 }, // 0x26 &
    { 0x06, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x27 '
    { 0x18, 0x0C, 0x06, 0x06, 0x06, 0x0C, 0x18, 0x00 }, // 0x28 (
    { 0x06, 0x0C, 0x18, 0x18, 0x18, 0x0C, 0x06, 0x00 }, // 0x29 )
    { 0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00 }, // 0x2A *
    { 0x00, 0x0C, 0x0C, 0x3F, 0x0C, 0x0C, 0x00, 0x00 }, // 0x2B +
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x06 }, // 0x2C ,
    { 0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x00 }, // 0x2D -
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00 }, // 0x2E .
    { 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00 }, // 0x2F /
    { 0x3E, 0x63, 0x73, 0x7B, 0x6F, 0x67, 0x3E, 0x00 }, // 0x30 0
    { 0x0C, 0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F, 0x00 }, // 0x31 1
    { 0x1E, 0x33, 0x30, 0x1C, 0x06, 0x33, 0x3F, 0x00 }, // 0x32 2
    { 0x1E, 0x33, 0x30, 0x1C, 0x30, 0x33, 0x1E, 0x00 }, // 0x33 3
    { 0x38, 0x3C, 0x36, 0x33, 0x7F, 0x30, 0x78, 0x00 }, // 0x34 4
    { 0x3F, 0x03, 0x1F, 0x30, 0x30, 0x33, 0x1E, 0x00 }, // 0x35 5
    { 0x1C, 0x06, 0x03, 0x1F, 0x33, 0x33, 0x1E, 0x00 }, // 0x36 6
    { 0x3F, 0x33, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x00 }, // 0x37 7
    { 0x1E, 0x33, 0x33, 0x1E, 0x33, 0x33, 0x1E, 0x00 }, // 0x38 8
    { 0x1E, 0x33, 0x33, 0x3E, 0x30, 0x18, 0x0E, 0x00 }, // 0x39 9
    { 0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x00 }, // 0x3A :
    { 0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x06 }, // 0x3B ;
    { 0x18, 0x0C, 0x06, 0x03, 0x06, 0x0C, 0x18, 0x00 }, // 0x3C <
    { 0x00, 0x00, 0x3F, 0x00, 0x00, 0x3F, 0x00, 0x00 }, // 0x3D =
    { 0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00 }, // 0x3E >
    { 0x1E, 0x33, 0x30, 0x18, 0x0C, 0x00, 0x0C, 0x00 }, // 0x3F ?
    { 0x3E, 0x63, 0x7B, 0x7B, 0x7B, 0x03, 0x1E, 0x00 }, // 0x40 @
    { 0x0C, 0x1E, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x00 }, // 0x41 A
    { 0x3F, 0x66, 0x66, 0x3E, 0x66, 0x66, 0x3F, 0x00 }, // 0x42 B
    { 0x3C, 0x66, 0x03, 0x03, 0x03, 0x66, 0x3C, 0x00 }, // 0x43 C
    { 0x1F, 0x36, 0x66, 0x66, 0x66, 0x36, 0x1F, 0x00 }, // 0x44 D
    { 0x7F, 0x46, 0x16, 0x1E, 0x16, 0x46, 0x7F, 0x00 }, // 0x45 E
    { 0x7F, 0x46, 0x16, 0x1E, 0x16, 0x06, 0x0F, 0x00 }, // 0x46 F
    { 0x3C, 0x66, 0x03, 0x03, 0x73, 0x66, 0x7C, 0x00 }, // 0x47 G
    { 0x33, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x33, 0x00 }, // 0x48 H
    { 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00 }, // 0x49 I
    { 0x78, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E, 0x00 }, // 0x4A J
    { 0x67, 0x66, 0x36, 0x1E, 0x36, 0x66, 0x67, 0x00 }, // 0x4B K
    { 0x0F, 0x06, 0x06, 0x06, 0x46, 0x66, 0x7F, 0x00 }, // 0x4C L
    { 0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x00 }, // 0x4D M
    { 0x63, 0x67, 0x6F, 0x7B, 0x73, 0x63, 0x63, 0x00 }, // 0x4E N
    { 0x1C, 0x36, 0x63, 0x63, 0x63, 0x36, 0x1C, 0x00 }, // 0x4F O
    { 0x3F, 0x66, 0x66, 0x3E, 0x06, 0x06, 0x0F, 0x00 }, // 0x50 P
    { 0x1E, 0x33, 0x33, 0x33, 0x3B, 0x1E, 0x38, 0x00 }, // 0x51 Q
    { 0x3F, 0x66, 0x66, 0x3E, 0x36, 0x66, 0x67, 0x00 }, // 0x52 R
    { 0x1E, 0x33, 0x07, 0x0E, 0x38, 0x33, 0x1E, 0x00 }, // 0x53 S
    { 0x3F, 0x2D, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00 }, // 0x54 T
    { 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3F, 0x00 }, // 0x55 U
    { 0x33, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00 }, // 0x56 V
    { 0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00 }, // 0x57 W
    { 0x63, 0x63, 0x36, 0x1C, 0x1C, 0x36, 0x63, 0x00 }, // 0x58 X
    { 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x0C, 0x1E, 0x00 }, // 0x59 Y
    { 0x7F, 0x63, 0x31, 0x18, 0x4C, 0x66, 0x7F, 0x00 }, // 0x5A Z
    // ... more characters would be defined here
};

// Initialize the GUI
void gui_init() {
    if (gui_initialized) {
        return;
    }
    
    // In a real system, we would:
    // 1. Detect the graphics hardware
    // 2. Set up the framebuffer
    // 3. Initialize the window manager
    
    // For now, just set some default values
    framebuffer = (unsigned int*) 0xA0000000; // Arbitrary address
    framebuffer_width = 800;
    framebuffer_height = 600;
    framebuffer_bpp = 32;
    framebuffer_pitch = framebuffer_width * 4;
    
    // Clear the screen
    gui_clear_screen(GUI_COLOR_BLACK);
    
    gui_initialized = 1;
    gui_mode = GUI_MODE_GRAPHICS;
}

// Switch between GUI and text mode
void gui_switch_mode() {
    if (!gui_initialized) {
        gui_init();
        return;
    }
    
    if (gui_mode == GUI_MODE_TEXT) {
        // Switch to graphics mode
        gui_mode = GUI_MODE_GRAPHICS;
        
        // Clear the screen
        gui_clear_screen(GUI_COLOR_BLACK);
        
        // Draw the GUI
        gui_draw_desktop();
    } else {
        // Switch to text mode
        gui_mode = GUI_MODE_TEXT;
        
        // Clear the screen and initialize the text mode
        terminal_initialize();
    }
}

// Get the current GUI mode
int gui_get_mode() {
    return gui_mode;
}

// Clear the screen with a specific color
void gui_clear_screen(unsigned int color) {
    if (!gui_initialized || gui_mode != GUI_MODE_GRAPHICS) {
        return;
    }
    
    for (int y = 0; y < framebuffer_height; y++) {
        for (int x = 0; x < framebuffer_width; x++) {
            framebuffer[y * framebuffer_width + x] = color;
        }
    }
}

// Set a pixel at a specific position
void gui_set_pixel(int x, int y, unsigned int color) {
    if (!gui_initialized || gui_mode != GUI_MODE_GRAPHICS) {
        return;
    }
    
    if (x < 0 || x >= framebuffer_width || y < 0 || y >= framebuffer_height) {
        return; // Out of bounds
    }
    
    framebuffer[y * framebuffer_width + x] = color;
}

// Draw a line
void gui_draw_line(int x1, int y1, int x2, int y2, unsigned int color) {
    // Bresenham's line algorithm
    int dx = abs(x2 - x1);
    int dy = abs(y2 - y1);
    int sx = (x1 < x2) ? 1 : -1;
    int sy = (y1 < y2) ? 1 : -1;
    int err = dx - dy;
    
    while (1) {
        gui_set_pixel(x1, y1, color);
        
        if (x1 == x2 && y1 == y2) {
            break;
        }
        
        int e2 = 2 * err;
        
        if (e2 > -dy) {
            err -= dy;
            x1 += sx;
        }
        
        if (e2 < dx) {
            err += dx;
            y1 += sy;
        }
    }
}

// Draw a rectangle
void gui_draw_rect(int x, int y, int width, int height, unsigned int color) {
    gui_draw_line(x, y, x + width - 1, y, color);
    gui_draw_line(x, y, x, y + height - 1, color);
    gui_draw_line(x + width - 1, y, x + width - 1, y + height - 1, color);
    gui_draw_line(x, y + height - 1, x + width - 1, y + height - 1, color);
}

// Fill a rectangle
void gui_fill_rect(int x, int y, int width, int height, unsigned int color) {
    for (int j = y; j < y + height; j++) {
        for (int i = x; i < x + width; i++) {
            gui_set_pixel(i, j, color);
        }
    }
}

// Draw a character
void gui_draw_char(int x, int y, char c, unsigned int color) {
    if (c < 0 || c >= 128) {
        c = '?';
    }
    
    for (int j = 0; j < 8; j++) {
        unsigned char row = font_8x8[(unsigned char)c][j];
        
        for (int i = 0; i < 8; i++) {
            if (row & (1 << i)) {
                gui_set_pixel(x + i, y + j, color);
            }
        }
    }
}

// Draw a string
void gui_draw_string(int x, int y, const char* str, unsigned int color) {
    int i = 0;
    
    while (str[i]) {
        gui_draw_char(x + i * 8, y, str[i], color);
        i++;
    }
}

// Draw the desktop
void gui_draw_desktop() {
    // Draw the background
    gui_clear_screen(GUI_COLOR_DARK_GRAY);
    
    // Draw the taskbar
    gui_fill_rect(0, framebuffer_height - 30, framebuffer_width, 30, GUI_COLOR_LIGHT_GRAY);
    
    // Draw the start button
    gui_fill_rect(5, framebuffer_height - 25, 80, 20, GUI_COLOR_BLUE);
    gui_draw_string(15, framebuffer_height - 20, "Start", GUI_COLOR_WHITE);
    
    // Draw the mode switch button
    gui_fill_rect(framebuffer_width - 85, framebuffer_height - 25, 80, 20, GUI_COLOR_GREEN);
    gui_draw_string(framebuffer_width - 75, framebuffer_height - 20, "CLI Mode", GUI_COLOR_BLACK);
    
    // Draw the window
    gui_fill_rect(100, 100, 400, 300, GUI_COLOR_WHITE);
    gui_draw_rect(100, 100, 400, 300, GUI_COLOR_BLACK);
    
    // Draw the window title bar
    gui_fill_rect(100, 100, 400, 20, GUI_COLOR_BLUE);
    gui_draw_string(110, 105, "LightOS - Welcome", GUI_COLOR_WHITE);
    
    // Draw the window content
    gui_draw_string(110, 130, "Welcome to LightOS!", GUI_COLOR_BLACK);
    gui_draw_string(110, 150, "A fast, resource-efficient operating system", GUI_COLOR_BLACK);
    gui_draw_string(110, 170, "with powerful server capabilities.", GUI_COLOR_BLACK);
    
    // Draw some buttons
    gui_fill_rect(110, 200, 100, 30, GUI_COLOR_LIGHT_GRAY);
    gui_draw_rect(110, 200, 100, 30, GUI_COLOR_BLACK);
    gui_draw_string(125, 210, "Server", GUI_COLOR_BLACK);
    
    gui_fill_rect(220, 200, 100, 30, GUI_COLOR_LIGHT_GRAY);
    gui_draw_rect(220, 200, 100, 30, GUI_COLOR_BLACK);
    gui_draw_string(235, 210, "DevOps", GUI_COLOR_BLACK);
    
    gui_fill_rect(330, 200, 100, 30, GUI_COLOR_LIGHT_GRAY);
    gui_draw_rect(330, 200, 100, 30, GUI_COLOR_BLACK);
    gui_draw_string(345, 210, "Deploy", GUI_COLOR_BLACK);
}
